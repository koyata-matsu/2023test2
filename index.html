<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Shift Maker</title>

  <!-- ★ API の場所 -->
  <script>
    window.SHIFT_API_BASE = "https://shiftmaker-yyq8.onrender.com";
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 40px;
    }
    .card {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    input, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
    }
    button {
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- ログイン画面 -->
  <div id="login" class="card">
    <h2>ログイン</h2>
    <input id="email" type="email" placeholder="メールアドレス" />
    <input id="password" type="password" placeholder="パスワード" />
    <button onclick="login()">ログイン</button>
    <button onclick="register()">新規登録</button>
    <p id="error" style="color:red;"></p>
  </div>

  <!-- ログイン後 -->
  <div id="app" class="card hidden">
    <h2 id="welcome"></h2>
    <button onclick="logout()">ログアウト</button>
  </div>

<script>
  const API = window.SHIFT_API_BASE;
  const tokenKey = "shift_token";

  async function login() {
    const email = email.value;
    const password = password.value;

    const res = await fetch(API + "/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (!res.ok) {
      error.innerText = data.error;
      return;
    }

    localStorage.setItem(tokenKey, data.token);
    showApp(data.email);
  }

  async function register() {
    const email = email.value;
    const password = password.value;

    const res = await fetch(API + "/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (!res.ok) {
      error.innerText = data.error;
      return;
    }

    alert("登録完了。ログインしてください。");
  }

  function logout() {
    localStorage.removeItem(tokenKey);
    location.reload();
  }

  function showApp(email) {
    login.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText = "ログイン中：" + email;
  }

  // ページ読み込み時にログイン状態チェック
  async function init() {
    const token = localStorage.getItem(tokenKey);
    if (!token) return;

    const res = await fetch(API + "/api/me", {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) return;

    const data = await res.json();
    showApp(data.email);
  }

  init();
</script>
</body>
</html>
